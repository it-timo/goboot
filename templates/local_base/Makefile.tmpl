#  -----------------------------------------------------------------------------
#  Makefile — Developer Targets for `{{.ProjectName}}`
#  -----------------------------------------------------------------------------
#
#  This Makefile defines reproducible and documented developer commands for working with the `{{.ProjectName}}` project.
#
#  Targets are intended to be simple and transparent.
#
#  Usage:
#    make [target]
#
#  Example:
#    make version  → Show current project version
#    make          → Default target
#
#  File generated by goboot — do not reuse blindly.
#  -----------------------------------------------------------------------------

# Project metadata (used in echo and version injection)
PROJECT := {{.ProjectName}}
VERSION := $(shell cat .version)

#  ----------------------------------------
#  Setup
#  ----------------------------------------
ROOT_DIR := $(PWD)
DOCKER_RUN := docker run --rm -v "$(ROOT_DIR):/workdir" -w /workdir
SH_FILES := $(shell find . -type f -name '*.sh')

# .PHONY declares non-file targets to always run when invoked
.PHONY: all build clean test lint release version help

#  ----------------------------------------
#  Default target (runs when `make` is called with no args)
#  ----------------------------------------
all: lint

#  ----------------------------------------
#  Build the project
#  ----------------------------------------
build:
	@echo "Building $(PROJECT)..."

#  ----------------------------------------
#  Clean build/test artifacts
#  ----------------------------------------
clean:
	@echo "Cleaning artifacts..."

#  ----------------------------------------
#  Run project tests
#  ----------------------------------------
test:
	@echo "Running tests..."
{{- $tests := index .MakeScripts "base_test" }}
{{- if not $tests }}
	@echo "No tests enabled in test config."
{{- else }}
{{- $test := index $tests 0 }}
	{{ oneLine $test }}
{{- end }}


#  ----------------------------------------
#  Run linters
#  ----------------------------------------
{{- $linters := index .MakeScripts "base_lint" -}}
{{- if not $linters }}

lint:
	@echo "No linters enabled in linter config."

{{- else }}
{{- if le (len $linters) 4 }}

lint:
	@echo "Linting..."
{{- range $cmd := $linters }}
	{{ replace (replace $cmd "{{DOCKER_RUN}}" "$(DOCKER_RUN)") "{{SH_FILES}}" "$(SH_FILES)" }}
{{- end }}

{{- else }}

.PHONY: lint_1 lint_2

lint: lint_1 lint_2

lint_1:
	@echo "Linting (part 1)..."
{{- range $cmd := slice $linters 0 4 }}
	{{ replace (replace $cmd "{{DOCKER_RUN}}" "$(DOCKER_RUN)") "{{SH_FILES}}" "$(SH_FILES)" }}
{{- end }}

lint_2:
	@echo "Linting (part 2)..."
{{- range $cmd := slice $linters 4 }}
	{{ replace (replace $cmd "{{DOCKER_RUN}}" "$(DOCKER_RUN)") "{{SH_FILES}}" "$(SH_FILES)" }}
{{- end }}

{{- end }}
{{- end }}


#  ----------------------------------------
#  Release the project
#  ----------------------------------------
release:
	@echo "Running release (version: $(VERSION))..."

#  ----------------------------------------
#  Show the current version
#  ----------------------------------------
version:
	@echo "$(PROJECT) version: $(VERSION)"

#  ----------------------------------------
#  Print usage help
#  Keep in sync with available targets
#  ----------------------------------------
help: help_core help_project help_check

help_core:
	@echo "Usage:"
	@echo "  make             Default target (run all)"
	@echo "  make help        Show this help message"
	@echo "  make clean       Remove build/test artifacts"

help_project:
	@echo "  make version     Show current project version"
	@echo "  make build       Build the project"
	@echo "  make release     Package the project using GoReleaser"

help_check:
	@echo "  make test        Run project tests"
	@echo "  make lint        Run static code analysis"
